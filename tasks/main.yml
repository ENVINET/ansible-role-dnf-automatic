---

- name: Install dnf-automatic package
  ansible.builtin.package:
    name: dnf-automatic
    state: present

- name: Deploy dnf-automatic configuration file
  ansible.builtin.template:
    src: automatic.conf.j2
    dest: /etc/dnf/automatic.conf
    mode: 0644

- name: Perform auto reboot specific tasks
  when: dnf_automatic_reboot | bool
  block:
    - name: Install dependencies needed for reboot
      ansible.builtin.package:
        name: "{{ dnf_automatic_reboot_dependencies }}"
        state: present

    - name: Deploy service and timer units
      ansible.builtin.template:
        src: "{{ item }}"
        dest: "/etc/systemd/system/{{ item }}"
        owner: root
        group: root
        mode: 0644
      loop:
        - dnf-automatic-reboot.service
        - dnf-automatic-reboot.timer

- name: Populate service facts
  ansible.builtin.service_facts:

- name: Start and enable systemd timer for dnf-automatic
  ansible.builtin.service:
    name: dnf-automatic-install.timer
    state: started
    enabled: true
  when: ansible_facts.services['dnf-automatic-install.timer'] is defined

- name: Set timer state for auto reboot
  ansible.builtin.systemd:
    name: dnf-automatic-reboot.timer
    state: "{{ dnf_automatic_reboot | ternary('started', 'stopped') }}"
    enabled: "{{ dnf_automatic_reboot }}"
    masked: false
    daemon_reload: true
  when: ansible_facts.services['dnf-automatic-reboot.timer'] is defined
